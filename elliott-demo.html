<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>شارت موجات إليوت مع Plotly Candlestick</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { background: #222; color: #fff; font-family: Tahoma; text-align: center }
        #plotly_chart { margin: 40px auto; width: 900px; height: 500px; }
        .results { margin: 24px auto; width: 900px; background:#1a1a2e; border-radius:10px; padding:20px; text-align: left; }
        .wave-label { font-weight: bold; font-size: 18px; }
        .error { color: #ff4757; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>شارت موجات إليوت مع Plotly Candlestick</h2>
    <div id="plotly_chart"></div>
    <div id="analysisResult" class="results"></div>
    <script src="elliott-wave.js"></script>
    <script>
        // بيانات أسعار تجريبية أو من السوق الحقيقي (يمكنك استبدالها لاحقاً)
        const klineData = [
            [1690000000000, "100", "105", "99", "104", "1500"],
            [1690003600000, "104", "108", "103", "107", "1700"],
            [1690007200000, "107", "109", "105", "106", "1600"],
            [1690010800000, "106", "110", "104", "110", "1800"],
            [1690014400000, "110", "115", "109", "114", "2000"],
            [1690018000000, "114", "116", "111", "112", "1900"],
            [1690021600000, "112", "113", "110", "111", "1200"],
            [1690025200000, "111", "115", "109", "114", "1400"],
            [1690028800000, "114", "117", "112", "116", "1700"],
            [1690032400000, "116", "119", "115", "118", "1800"],
            [1690036000000, "118", "120", "117", "119", "1600"],
            [1690039600000, "119", "122", "118", "121", "1850"],
            [1690043200000, "121", "123", "120", "122", "1750"],
            [1690046800000, "122", "124", "121", "123", "1600"],
            [1690050400000, "123", "126", "122", "125", "1900"],
            [1690054000000, "125", "128", "124", "127", "2000"],
            [1690057600000, "127", "130", "126", "129", "2100"],
            [1690061200000, "129", "132", "128", "131", "2200"],
            [1690064800000, "131", "134", "130", "133", "2300"],
            [1690068400000, "133", "136", "132", "135", "2400"]
        ]; // استخدم بياناتك الحقيقية هنا!

        // استخدم المحلل
        const analyzer = new ElliottWaveAnalyzer();
        const analysis = analyzer.analyze(klineData);

        // تجهيز بيانات الشموع لـ Plotly
        const times  = klineData.map(k => new Date(Number(k[0])));
        const open   = klineData.map(k => Number(k[1]));
        const high   = klineData.map(k => Number(k[2]));
        const low    = klineData.map(k => Number(k[3]));
        const close  = klineData.map(k => Number(k[4]));

        // تحضير نقاط موجات إليوت للترقيم
        let annotations = [];
        if (analysis.patterns && analysis.patterns.length > 0) {
            const pattern = analysis.patterns[0];
            pattern.points.forEach((pt, idx) => {
                const x = times[pt.index];
                const y = pt.price;
                const label = pattern.type === "motive" ? (idx + 1) : String.fromCharCode(65 + idx); // 1,2,3... أو A,B,C...
                annotations.push({
                    x: x,
                    y: y,
                    text: label,
                    xref: 'x',
                    yref: 'y',
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -30,
                    font: {
                        color: pattern.type === "motive" ? "#ff4757" : "#ffa502",
                        size: 18,
                        family: "Tahoma"
                    },
                    bgcolor: "#fff",
                    bordercolor: "#222"
                });
            });
        }

        // رسم الشارت بالشموع وترقيم موجات إليوت
        Plotly.newPlot('plotly_chart', [{
            x: times,
            open: open,
            high: high,
            low: low,
            close: close,
            type: 'candlestick',
            name: 'الشموع'
        }], {
            margin: { t: 30, r: 30, l: 50, b: 50 },
            plot_bgcolor: "#111",
            paper_bgcolor: "#222",
            annotations: annotations,
            xaxis: {
                title: "الزمن",
                color: "#fff",
                rangeslider: { visible: false },
                showgrid: false
            },
            yaxis: {
                title: "السعر",
                color: "#fff",
                showgrid: true
            }
        });

        // عرض النتائج النصية والتحليل
        function showAnalysis(analysis) {
            const div = document.getElementById("analysisResult");
            if (!analysis || !analysis.patterns || analysis.patterns.length === 0) {
                return div.innerHTML = '<div class="error">لم يتم العثور على نمط موجات إليوت صالح في البيانات.</div>';
            }
            const pattern = analysis.patterns[0];
            let html = `
                <h3>نتيجة التحليل:</h3>
                <p><span class="wave-label">النمط:</span> ${pattern.type === 'motive' ? 'دافع (1-2-3-4-5)' : 'تصحيحي (A-B-C)'}</p>
                <p><span class="wave-label">الاتجاه:</span> ${pattern.direction === 'bullish' ? 'صاعد 🚀' : 'هابط 📉'}</p>
                <p><span class="wave-label">الثقة:</span> ${pattern.confidence}%</p>
                <p><span class="wave-label">موجات التحليل:</span> ${pattern.points.map((pt, idx) => pattern.type === 'motive' ? (idx + 1) : String.fromCharCode(65 + idx)).join(' - ')}</p>
                <p><span class="wave-label">الهدف المتوقع:</span> $${pattern.targets.finalTarget.toFixed(2)}</p>
                <p><span class="wave-label">الدعم:</span> $${pattern.targets.support.toFixed(2)} | <span class="wave-label">المقاومة:</span> $${pattern.targets.resistance.toFixed(2)}</p>
                <hr>
                <p><span class="wave-label">التوصية:</span> ${
                    analysis.recommendations && analysis.recommendations.length > 0 ?
                    analysis.recommendations[0].message : 'لا توجد توصية واضحة حالياً'
                }</p>
                <p><span class="wave-label">الملخص:</span> ${analysis.summary}</p>
            `;
            div.innerHTML = html;
        }
        showAnalysis(analysis);
    </script>
</body>
</html>
